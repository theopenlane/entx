{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "historyQuery" }}
//go:build !codegen
// Code generated by entx.history, DO NOT EDIT.
	{{- $pkg := base $.Config.Package }}
	{{- template "header" $ }}
import (
	"context"
	"time"

	"entgo.io/ent/dialect/sql"

	{{- range $n := $.Nodes }}
		{{- $name := $n.Name }}
		{{- $history := hasSuffix $name "History" }}
		{{- if $history }}
		"{{ $.Config.Package }}/{{ lower $n.Name }}"
		{{- end }}
	{{- end }}
)

	{{ range $n := $.Nodes }}
		{{ $name := $n.Name }}

		{{ $history := hasSuffix $name "History" }}
		{{ if $history }}
		{{ else }}
			{{- $include := or ( not $n.Annotations.History ) (eq $n.Annotations.History.Exclude false) }}
			{{- if $include }}
				func ({{ $n.Receiver }} *{{ $n.Name }}) History() *{{ $n.QueryName }}  {
					historyClient := New{{ $n.Name }}HistoryClient({{ $n.Receiver }}.config)
					return historyClient.Query().Where({{ lower $n.Name }}history.Ref({{ $n.Receiver }}.ID))
				}

				func ({{ $n.Receiver }}History *{{ $n.Name }}) Next(ctx context.Context) (*{{ $n.Name }}, error) {
					client := New{{ $n.Name }}Client({{ $n.Receiver }}.config)
					return client.Query().
						Where(
							{{ lower $n.Name }}.Ref({{ $n.Receiver }}.Ref),
							{{ lower $n.Name }}.HistoryTimeGT({{ $n.Receiver }}.HistoryTime),
						).
						Order({{ lower $n.Name }}.ByHistoryTime()).
						First(ctx)
				}

				func ({{ $n.Receiver }} *{{ $n.Name }}) Prev(ctx context.Context) (*{{ $n.Name }}, error) {
					client := New{{ $n.Name }}Client({{ $n.Receiver }}.config)
					return client.Query().
						Where(
							{{ lower $n.Name }}.Ref({{ $n.Receiver }}.Ref),
							{{ lower $n.Name }}.HistoryTimeLT({{ $n.Receiver }}.HistoryTime),
						).
						Order({{ lower $n.Name }}.ByHistoryTime(sql.OrderDesc())).
						First(ctx)
				}

				func ({{ receiver $n.QueryName }} *{{ $n.QueryName }}) Earliest(ctx context.Context) (*{{ $n.Name }}, error)  {
					return {{ receiver $n.QueryName }}.
								Order({{ lower $n.Name }}.ByHistoryTime()).
								First(ctx)
				}

				func ({{ receiver $n.QueryName }} *{{ $n.QueryName }}) Latest(ctx context.Context) (*{{ $n.Name }}, error)  {
					return {{ receiver $n.QueryName }}.
								Order({{ lower $n.Name }}.ByHistoryTime(sql.OrderDesc())).
								First(ctx)
				}

				func ({{ receiver $n.QueryName }} *{{ $n.QueryName }}) AsOf(ctx context.Context, time time.Time) (*{{ $n.Name }}, error)  {
					return {{ receiver $n.QueryName }}.
								Where({{ lower $n.Name }}.HistoryTimeLTE(time)).
								Order({{ lower $n.Name }}.ByHistoryTime(sql.OrderDesc())).
								First(ctx)
				}

				{{ if not (fieldPropertiesNillable $.Annotations.HistoryConfig) }}
				func ({{ $n.Receiver }} *{{ $n.Name }}) Restore(ctx context.Context) (*{{ $n.Name }}, error) {
					client := New{{ $n.Name }}Client({{ $n.Receiver }}.config)
					return client.
						UpdateOneID({{ $n.Receiver }}.Ref).
					{{- range $f := $n.Fields }}
					{{- if not $f.Immutable }}
						Set{{ if $f.Nillable }}Nillable{{ end }}{{ $f.StructField }}({{ $n.Receiver }}.{{ pascal $f.Name }}).
					{{- end }}
					{{- end }}
						Save(ctx)
				}
				{{ end }}
			{{ end }}
		{{ end }}
	{{ end }}
{{ end }}